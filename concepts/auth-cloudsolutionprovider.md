---
title: Llamar a Microsoft Graph desde una aplicación del proveedor de soluciones en la nube
description: En este tema se describe cómo habilitar el acceso de la aplicación a datos de clientes administrados por el asociado a través de Microsoft Graph mediante el flujo de concesión del código de autorización o del flujo de credenciales de cliente de servicio a servicio.
author: jackson-woods
ms.openlocfilehash: 3640cde7fb3b1c49e87a0e06e293aba8c656e264
ms.sourcegitcommit: 6a82bf240a3cfc0baabd227349e08a08311e3d44
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 12/18/2018
ms.locfileid: "27361869"
---
# <a name="call-microsoft-graph-from-a-cloud-solution-provider-application"></a><span data-ttu-id="fc3fd-103">Llamar a Microsoft Graph desde una aplicación del proveedor de soluciones en la nube</span><span class="sxs-lookup"><span data-stu-id="fc3fd-103">Call Microsoft Graph from a Cloud Solution Provider application</span></span>

> <span data-ttu-id="fc3fd-p101">**Nota:** Este tema **solo** se aplica a los desarrolladores de aplicaciones del proveedor de soluciones en la nube (CSP) de Microsoft. El programa del [Proveedor de soluciones en la nube (CSP) de Microsoft](https://partner.microsoft.com/es-ES/cloud-solution-provider) permite a los asociados de Microsoft revender y administrar Microsoft Online Services para los clientes.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p101">**Note:** This topic applies **only** to Microsoft Cloud Solution Provider (CSP) application developers. The [Microsoft Cloud Solution Provider (CSP)](https://partner.microsoft.com/es-ES/cloud-solution-provider) program enables Microsoft’s partners to resell and manage Microsoft Online services to customers.</span></span>

<span data-ttu-id="fc3fd-106">En este tema se describe cómo habilitar el acceso de la aplicación a datos de clientes administrados por el asociado a través de Microsoft Graph mediante el [flujo de concesión del código de autorización](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code) o del [flujo de credenciales de cliente de servicio a servicio](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).</span><span class="sxs-lookup"><span data-stu-id="fc3fd-106">This topic describes how to enable application access to partner-managed customer data via Microsoft Graph using either the [authorization code grant flow](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code) or the [service to service client credentials flow](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).</span></span>

<span data-ttu-id="fc3fd-107">**Importante:** Solo se permite llamar a Microsoft Graph desde una aplicación CSP para los recursos de directorio (como **usuario**, **grupo**,**dispositivo**, **organización**) y recursos de [Intune](/graph/api/resources/intune-graph-overview?view=graph-rest-beta).</span><span class="sxs-lookup"><span data-stu-id="fc3fd-107">**Important:** Calling Microsoft Graph from a CSP application is only supported for directory resources (such as **user**, **group**,**device**, **organization**) and [Intune](/graph/api/resources/intune-graph-overview?view=graph-rest-beta) resources.</span></span>

## <a name="what-is-a-partner-managed-application"></a><span data-ttu-id="fc3fd-108">¿Qué es una aplicación administrada por el asociado?</span><span class="sxs-lookup"><span data-stu-id="fc3fd-108">What is a partner-managed application</span></span>

<span data-ttu-id="fc3fd-p102">El programa CSP permite a los asociados de Microsoft revender y administrar Microsoft Online Services (como Office 365, Microsoft Azure y CRM Online) para los clientes. La administración de los servicios de cliente se realiza a través de privilegios de administración delegados, lo que permite que los usuarios asociados designados (denominados "agentes") tengan acceso a los entornos de sus clientes y los configuren.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p102">The CSP program enables Microsoft’s partners to resell and manage Microsoft Online Services (such as Office 365, Microsoft Azure, and CRM Online) to customers. Management of customer services is done through Delegated Admin Privileges, which enables designated partner users (known as agents) to access and configure their customers’ environments.</span></span>

<span data-ttu-id="fc3fd-p103">Además, como desarrollador asociado, puede compilar una **aplicación administrada por el asociado** para administrar los servicios de Microsoft de sus clientes. Las aplicaciones administradas por el asociado suelen denominarse aplicaciones *aceptadas previamente*, ya que se acepta previamente a todos los clientes de forma automática para las aplicaciones administradas por el asociado. Esto significa que cuando un usuario de uno de los inquilinos de cliente usa una de las aplicaciones administradas por el asociado, el usuario puede usarla sin que se le pida el consentimiento. Las aplicaciones administradas por el asociado también heredan los privilegios de administración delegados, por lo que los agentes asociados también pueden obtener acceso privilegiado a los clientes a través de la aplicación administrada por el asociado.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p103">Additionally, as a partner developer, you can build a **partner-managed app** to manage your customers' Microsoft services. Partner-managed apps are often called *pre-consented* apps because all your customers are automatically pre-consented for your partner-managed apps. This means when a user from one of your customer tenants uses one of your partner-managed apps, the user can use it without being prompted to give consent. Partner-managed apps also inherit Delegated Admin Privileges, so your partner agents can also get privileged access to your customers through your partner-managed application.</span></span>

## <a name="how-to-set-up-a-partner-managed-application"></a><span data-ttu-id="fc3fd-115">Cómo configurar una aplicación administrada por el asociado</span><span class="sxs-lookup"><span data-stu-id="fc3fd-115">How to set-up a partner-managed application</span></span>

<span data-ttu-id="fc3fd-116">Una aplicación se muestra como *administrada por el asociado* cuando se le han concedido permisos elevados para tener acceso a los datos de los clientes.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-116">An application is viewed as *partner-managed* when it is granted elevated permissions to access your customers' data.</span></span>

> <span data-ttu-id="fc3fd-117">**Nota:** Las aplicaciones administradas por el asociado *solo* pueden configurarse en los inquilinos del asociado, y con el fin de administrar los recursos del inquilino cliente, las aplicaciones administradas por el asociado **deben** configurarse como **aplicaciones multiinquilino**.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-117">**Note:** Partner-managed apps can *only* be configured on Partner tenants, and in order to manage customer tenant resources, partner-managed apps **must** be configured as **multi-tenant applications**.</span></span>

### <a name="register-and-configure-a-multi-tenant-app"></a><span data-ttu-id="fc3fd-118">Registrar y configurar una aplicación multiinquilino</span><span class="sxs-lookup"><span data-stu-id="fc3fd-118">Register and configure a multi-tenant app</span></span>

<span data-ttu-id="fc3fd-119">Aquí, los pasos iniciales necesarios son, en su mayoría, los mismos que se usan para registrar y configurar una aplicación multiinquilino:</span><span class="sxs-lookup"><span data-stu-id="fc3fd-119">The initial steps required here follow most of the same steps used to register and configure a multi-tenant application:</span></span>

1. <span data-ttu-id="fc3fd-p104">[Registre la aplicación](https://docs.microsoft.com/es-ES/azure/active-directory/active-directory-app-registration) en su inquilino asociado a través del [Azure Portal](https://portal.azure.com). Para que una aplicación funcione como administrada por el asociado, debe estar configurada como [aplicación multiinquilino](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant). Además, si la aplicación se implementa y se vende en varias regiones geográficas, deberá registrarla en cada una de esas regiones, tal como se describe <a href="#region">aquí</a>.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p104">[Register your application](https://docs.microsoft.com/es-ES/azure/active-directory/active-directory-app-registration) in your Partner tenant using the [Azure Portal](https://portal.azure.com). To function as a partner-managed app, an application must be configured as a [multi-tenant app](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant). Additionally, if your app is deployed and sold in multiple geographic regions you will need to register your app in each of those regions as described <a href="#region">here</a>.</span></span>
2. <span data-ttu-id="fc3fd-123">Configure la aplicación multiinquilino, de nuevo a través de Azure Portal, con los *permisos necesarios* mediante un enfoque de privilegios mínimos.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-123">Configure your multi-tenant app, again through the Azure Portal, with the *required permissions* it needs using a least privileged approach.</span></span>

### <a name="pre-consent-your-app-for-all-your-customers"></a><span data-ttu-id="fc3fd-124">Consentimiento previo de la aplicación para todos los clientes</span><span class="sxs-lookup"><span data-stu-id="fc3fd-124">Pre-consent your app for all your customers</span></span>

<span data-ttu-id="fc3fd-p105">Por último, conceda a la aplicación administrada por el asociado los permisos configurados para todos los clientes. Para hacerlo, agregue la entidad de servicio (**servicePrincipal**) que representa la aplicación en el grupo *Adminagents* del inquilino asociado mediante PowerShell V2 para Azure AD. Puede descargar e instalar PowerShell V2 para Azure AD desde [aquí](https://www.powershellgallery.com/packages/AzureAD).  Siga estos pasos para encontrar el grupo *Adminagents*, la **servicePrincipal** y agregarla al grupo.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p105">Finally grant your partner-managed app those configured permissions for all your customers. You can do this by adding the **servicePrincipal** that represents the app to the *Adminagents* group in your Partner tenant, using Azure AD powershell V2. You can download and install Azure AD PowerShell V2 from [here](https://www.powershellgallery.com/packages/AzureAD).  Follow these steps to find the *Adminagents* group, the **servicePrincipal** and add it to the group.</span></span>

1. <span data-ttu-id="fc3fd-129">Abra una sesión de PowerShell y conéctese al inquilino asociado. Para ello, escriba sus credenciales de administrador en la ventana de inicio de sesión.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-129">Open a PowerShell session and connect to your partner tenant by entering your admin credentials into the sign-in window.</span></span>

    ```PowerShell
    Connect-AzureAd
    ```

2. <span data-ttu-id="fc3fd-130">Busque el grupo *Adminagents*.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-130">Find the group that represents the *Adminagents*.</span></span>

    ```PowerShell
    $group = Get-AzureADGroup -Filter "displayName eq 'Adminagents'"
    ```

3. <span data-ttu-id="fc3fd-131">Busque la entidad de servicio que tenga el mismo *appId* que su aplicación.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-131">Find the service principal that has the same *appId* as your app.</span></span>

    ```PowerShell
    $sp = Get-AzureADServicePrincipal -Filter "appId eq '{yourAppsAppId}'"
    ```

4. <span data-ttu-id="fc3fd-132">Por último, agregue la entidad de servicio al grupo *Adminagents*.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-132">Finally, add the service principal to the *Adminagents* group.</span></span>

    ```PowerShell
    Add-AzureADGroupMember -ObjectId $group.ObjectId -RefObjectId $sp.ObjectId
    ```

## <a name="token-acquisition-flows"></a><span data-ttu-id="fc3fd-133">Flujos de adquisición de tokens</span><span class="sxs-lookup"><span data-stu-id="fc3fd-133">Token acquisition flows</span></span>

<span data-ttu-id="fc3fd-134">Los flujos de adquisición de tokens para las aplicaciones administradas por el asociado ([flujo de concesión del código de autorización](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code) y [flujo de credenciales de cliente de servicio a servicio](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service)) son iguales a los de las aplicaciones multiinquilino normales.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-134">Token acquisition flows for partner-managed apps - [authorization code grant flow](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code) and [service-to-service client credentials flow](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service) - are the same as regular multi-tenant apps.</span></span>

<span data-ttu-id="fc3fd-p106">Además del acceso aceptado previamente a todos los inquilinos del cliente, las aplicaciones administradas por el asociado tienen una función adicional que permite que los agentes usen la aplicación para tener acceso a los datos de inquilino de los clientes (mediante privilegios de administración delegados). Conceptualmente funciona de la siguiente manera:</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p106">Apart from pre-consented access to all your customer tenants, partner-managed apps have one additional capability. It allows for your agents to use your app to access your customers' tenant data (using delegated admin privileges). Conceptually it works like this:</span></span>

1. <span data-ttu-id="fc3fd-138">El agente inicia sesión en la aplicación con sus credenciales de usuario emitidas por el inquilino de asociado.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-138">Your agent signs in to your app with their user credentials issued from your partner tenant.</span></span>
2. <span data-ttu-id="fc3fd-139">La aplicación solicita un token de acceso para el inquilino de cliente administrado por el asociado previsto.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-139">Your app requests an access token for the intended partner-managed customer tenant.</span></span>
3. <span data-ttu-id="fc3fd-140">La aplicación usa el token de acceso para llamar a Microsoft Graph.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-140">Your app uses the access token to call Microsoft Graph.</span></span>

<span data-ttu-id="fc3fd-p107">Se trata de un estándar de [flujo para conceder el código de autorización](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code), salvo que los agentes deben iniciar sesión con sus cuentas de socio. Para ver el aspecto que tendría, imagine que el inquilino de asociado es *partner.com* (que es el inquilino principal de los agentes) y uno de los clientes es *customer.com*:</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p107">This is a standard [authorization code grant flow](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code), except that your agents must sign-in using their partner accounts. To see how this would look, imagine your partner tenant is *partner.com* (which is the home tenant for your agents) and one of your customers is *customer.com*:</span></span>

1. <span data-ttu-id="fc3fd-p108">[Adquiera un código de autorización:](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) La aplicación crea una solicitud para el punto de conexión ```/authorize``` y debe usar un **inquilino de cliente** (en nuestro ejemplo, ```customer.com```) para el inquilino de destino. Los agentes iniciarían sesión con su cuenta ```username@partner.com```.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p108">[Acquire an authorization code:](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) Your app makes a request to the ```/authorize``` endpoint and must use a **customer tenant**, in our example ```customer.com```, for the target tenant. Your agents would still sign-in with their ```username@partner.com``` account.</span></span>

    ```http
    GET https://login.microsoftonline.com/customer.com/oauth2/authorize
    ```

2. <span data-ttu-id="fc3fd-145">[Adquiera un token de acceso mediante el código de autorización:](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) La aplicación debe usar un **inquilino de cliente** como inquilino de destino (en nuestro ejemplo, ```customer.com```) al realizar la solicitud al punto de conexión ```token```:</span><span class="sxs-lookup"><span data-stu-id="fc3fd-145">[Aquire an access token using the authorization code:](https://docs.microsoft.com/es-ES/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) Your app must use a **customer tenant** as the target tenant, in our example ```customer.com```, when making the request to the ```token``` endpoint:</span></span>

    ```http
    POST https://login.microsoftonline.com/customer.com/oauth2/token
    ```

3. <span data-ttu-id="fc3fd-146">Ahora que tiene un token de acceso, llame a Microsoft Graph. Para ello, ponga el token de acceso en el encabezado de autorización HTTP:</span><span class="sxs-lookup"><span data-stu-id="fc3fd-146">Now you have an access token, call Microsoft Graph, putting the access token in the HTTP authorization header:</span></span>

    ```http
    GET https://graph.microsoft.com/beta/users
    Authorization: Bearer <token>
    ```

## <a name="register-your-app-in-the-regions-you-support"></a><span data-ttu-id="fc3fd-147">Registrar la aplicación en las regiones admitidas</span><span class="sxs-lookup"><span data-stu-id="fc3fd-147">Register your app in the regions you support</span></span>
<a name="region"></a>

<span data-ttu-id="fc3fd-p109">El compromiso con el cliente CSP está limitado actualmente a una sola región. Las aplicaciones administradas por el asociado conllevan la misma limitación. Esto significa que debe disponer de un inquilino independiente para cada región en la que venda. Por ejemplo, si la aplicación administrada por el asociado está registrada en un inquilino de los Estados Unidos pero el cliente está en la UE, la aplicación administrada por el asociado no funcionará.  Cada uno de los inquilinos de asociado regionales debe mantener su propio conjunto de aplicaciones administradas por el asociado para administrar a los clientes de la misma región. Esto podría requerir lógica adicional en la aplicación (antes del inicio de sesión) para obtener el nombre de usuario de inicio de sesión de los clientes, a fin de decidir qué identidad de la aplicación administrada por el asociado específica de la región se debe usar para dar servicio al usuario.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p109">CSP customer engagement is currently limited to a single region. Partner-managed applications carry the same limitation. This means you must have a separate tenant for each region you sell in. For example, if your partner-managed app is registered in a tenant in the US but your customer is in the EU – the partner-managed app will not work.  Each of your regional partner tenants must maintain their own set of partner-managed apps to manage customers within the same region. This might require additional logic in your app (prior to sign-in) to get your customers' sign-in username to decide which region-specific partner-managed app identity to use, to serve the user.</span></span>

## <a name="calling-microsoft-graph-immediately-after-customer-creation"></a><span data-ttu-id="fc3fd-154">Llamar a Microsoft Graph inmediatamente después de la creación del cliente</span><span class="sxs-lookup"><span data-stu-id="fc3fd-154">Calling Microsoft Graph immediately after customer creation</span></span>

<span data-ttu-id="fc3fd-p110">Cuando se crea un cliente mediante la [API Partner Center](https://partnercenter.microsoft.com/es-ES/partner/developer), se crea un inquilino de cliente. Además, también se crea una relación de asociado, que lo convierte a usted en asociado de registro para este nuevo inquilino de cliente. Esta relación de asociado puede tardar hasta tres minutos en propagarse al nuevo inquilino de cliente. Si la aplicación llama a Microsoft Graph justo después de la creación, es probable que reciba un error de acceso denegado. Es posible que experimente un retraso similar cuando un cliente existente acepte su invitación. Esto se debe a que la aceptación previa se basa en la relación de asociado presente en el inquilino de cliente.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p110">When you create a new customer using the [Partner Center API](https://partnercenter.microsoft.com/es-ES/partner/developer), a new customer tenant gets created. Additionally, a partner relationship also gets created, which makes you the partner of record for this new customer tenant. This partner relationship can take up to 3 minutes to propagate to the new customer tenant. If your app calls Microsoft Graph straight after creation, your app will likely receive an access denied error. A similar delay may be experienced when an existing customer accepts your invitation. This is because pre-consent relies on the partner relationship being present in the customer tenant.</span></span>

<span data-ttu-id="fc3fd-p111">Para evitar este problema, se recomienda que la aplicación de asociado espere **tres minutos** tras la creación del cliente antes de llamar a Azure AD para adquirir un token (a fin de llamar a Microsoft Graph). Esto debería abarcar la mayoría de los casos. Pero si al cabo de tres minutos sigue recibiendo un error de autorización, espere otros 60 segundos y vuelva a intentarlo.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p111">To avoid this problem, we recommend that your partner app should should wait **three minutes** after customer creation before calling Azure AD to acquire a token (to call Microsoft Graph). This should cover most cases. However, if after waiting three minutes you still recieve an authorization error, please wait an additional 60 seconds and try again.</span></span>

> <span data-ttu-id="fc3fd-p112">**Nota:** Durante el reintento, debe adquirir un nuevo token de acceso de Azure AD antes de llamar a Microsoft Graph.  No podrá llamar a Microsoft Graph con el token de acceso que ya tiene, ya que este es válido durante una hora y no contendrá las notificaciones del permiso aceptado previamente.</span><span class="sxs-lookup"><span data-stu-id="fc3fd-p112">**Note:** On the retry, you must acquire a new access token from Azure AD, before calling Microsoft Graph.  Calling Microsoft Graph with the access token you already have will not work, because the access token is good for an hour and won’t contain the pre-consented permission claims.</span></span>
